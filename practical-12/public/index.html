<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kids Calculator üåà</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;700&display=swap" rel="stylesheet">
    <style>
      :root{
        --bg1: #ffecd2; /* soft peach */
        --bg2: #fcb69f; /* salmon */
        --accent1: #7ee8fa; /* aqua */
        --accent2: #eec0c6; /* pink */
        --card: rgba(255,255,255,0.95);
        --muted: #334155;
      }
      *{box-sizing:border-box}
      html,body{height:100%;margin:0;font-family:'Baloo 2', system-ui, Arial, sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));}
      .stage{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}

      .card{width:100%;max-width:720px;background:var(--card);border-radius:22px;padding:28px;box-shadow:0 12px 40px rgba(2,6,23,0.12);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,0.6)}

      .header{display:flex;align-items:center;gap:16px}
      .logo{width:64px;height:64px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 6px 18px rgba(0,0,0,0.08);font-size:32px}
      h1{margin:0;font-size:28px;color:var(--muted)}
      p.lead{margin:6px 0 18px;color:#475569}

      .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
      label{display:block;margin-bottom:8px;font-weight:700;color:#0f172a}
      input[type=text], input[type=number]{width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(250,250,250,0.95));font-size:18px;box-shadow:inset 0 2px 6px rgba(2,6,23,0.04)}
      input[type=text]:focus, input[type=number]:focus{outline:3px solid rgba(125,211,252,0.18)}

      .controls{display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap}
      select{padding:12px;border-radius:12px;border:none;background:white;font-size:16px}

      .bigbtn{padding:12px 18px;border-radius:14px;border:none;background:linear-gradient(90deg,#8be9ff,#b6ffce);font-weight:800;font-size:18px;cursor:pointer;box-shadow:0 8px 24px rgba(34,197,94,0.12)}
      .bigbtn:active{transform:translateY(1px)}

      .resultBox{margin-top:18px;padding:16px;border-radius:12px;background:linear-gradient(90deg,rgba(255,255,255,0.6),rgba(255,255,255,0.8));text-align:center}
      .resultVal{font-size:40px;font-weight:900;color:#0b1220}
      .meta{margin-top:6px;color:#475569}

      .error{margin-top:12px;color:#b91c1c;font-weight:700;text-align:center}

      /* mobile */
      @media (max-width:640px){
        .grid{grid-template-columns:1fr}
        .header{gap:12px}
        .controls{justify-content:flex-start}
      }

      /* playful confetti dots */
      .dot{position:absolute;border-radius:999px;opacity:0.85;pointer-events:none}
      .dot--a{width:14px;height:14px;background:#ffd6a5;left:8%;top:6%}
      .dot--b{width:10px;height:10px;background:#caffbf;right:12%;top:14%}
      .dot--c{width:18px;height:18px;background:#9aedff;left:20%;bottom:10%}
    </style>
  </head>
  <body>
    <div class="stage">
      <div class="card" role="application" aria-labelledby="title">
        <div class="header">
          <div class="logo" aria-hidden="true">üßÆ</div>
          <div>
            <h1 id="title">Fun Kids Calculator</h1>
            <p class="lead">Add, subtract, multiply or divide ‚Äî big colorful buttons make math fun!</p>
          </div>
        </div>

        <div style="position:relative;margin-top:14px">
          <div class="dot dot--a"></div>
          <div class="dot dot--b"></div>
          <div class="dot dot--c"></div>

          <div class="grid" aria-hidden="false">
            <div>
              <label for="numA">Number A</label>
              <!-- use text + inputmode to allow decimals & leading +/-. type="text" keeps consistent behavior across browsers -->
              <input id="numA" name="a" type="text" inputmode="decimal" placeholder="e.g. 12" aria-label="Number A" autocomplete="off" />
            </div>
            <div>
              <label for="numB">Number B</label>
              <input id="numB" name="b" type="text" inputmode="decimal" placeholder="e.g. 3.5" aria-label="Number B" autocomplete="off" />
            </div>
          </div>

          <div class="controls" role="group" aria-label="Calculator controls">
            <label for="op" style="margin:0;font-weight:800;color:#0f172a">Operation</label>
            <select id="op" aria-label="Operation">
              <option value="add">‚ûï Add</option>
              <option value="sub">‚ûñ Subtract</option>
              <option value="mul">‚úñÔ∏è Multiply</option>
              <option value="div">‚ûó Divide</option>
            </select>

            <button id="calc" class="bigbtn" title="Calculate" type="button">Calculate</button>
            <button id="clear" class="bigbtn" type="button" style="background:linear-gradient(90deg,#ffd6a5,#ffb4c6);box-shadow:0 8px 24px rgba(249,115,22,0.12)">Clear</button>
          </div>

          <div id="error" class="error" role="alert" aria-live="polite"></div>

          <div id="resultBox" class="resultBox" aria-live="polite" hidden>
            <div class="resultVal" id="result">0</div>
            <div class="meta" id="meta">Nice work! üéâ</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Elements
      const aEl = document.getElementById('numA');
      const bEl = document.getElementById('numB');
      const opEl = document.getElementById('op');
      const calcBtn = document.getElementById('calc');
      const clearBtn = document.getElementById('clear');
      const resultBox = document.getElementById('resultBox');
      const resultEl = document.getElementById('result');
      const metaEl = document.getElementById('meta');
      const errorEl = document.getElementById('error');

      // Helpers
      function clearMsgs() {
        resultBox.hidden = true;
        errorEl.textContent = '';
      }

      // Validates input string -> { ok, value, msg }
      function validateInput(v) {
        if (v === null || v === undefined) return { ok:false, msg:'Missing number' };
        const trimmed = String(v).trim();
        if (trimmed === '') return { ok:false, msg:'Please enter a number' };
        // allow optional leading +/-, decimals and digits
        // Reject anything with letters (quick check)
        // Use Number() to parse (accepts "1e3" too). If you want to forbid exponent notation, adjust here.
        if (/[A-Za-z]/.test(trimmed)) return { ok:false, msg:'Invalid number: letters not allowed' };
        const num = Number(trimmed);
        if (Number.isNaN(num)) return { ok:false, msg:'Invalid number: check formatting' };
        return { ok:true, value: num };
      }

      function localCompute(a, b, op) {
        switch (op) {
          case 'add': return a + b;
          case 'sub': return a - b;
          case 'mul': return a * b;
          case 'div': return a / b;
        }
        return NaN;
      }

      function opSymbol(op){
        return op === 'add' ? '+' : op === 'sub' ? '-' : op === 'mul' ? '√ó' : '√∑';
      }

      // Main flow: try server, fallback to local
      async function doCalc() {
        clearMsgs();
        const aRaw = aEl.value;
        const bRaw = bEl.value;
        const op = opEl.value;

        const pa = validateInput(aRaw);
        if (!pa.ok) { errorEl.textContent = pa.msg; aEl.focus(); return; }
        const pb = validateInput(bRaw);
        if (!pb.ok) { errorEl.textContent = pb.msg; bEl.focus(); return; }
        if (op === 'div' && pb.value === 0) { errorEl.textContent = 'Division by zero is not allowed'; bEl.focus(); return; }

        // Try server call, but fallback locally if it fails or no server
        try {
          const res = await fetch('/api/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ a: pa.value, b: pb.value, op })
          });

          // If server returns Ok and JSON includes result -> use it
          if (res.ok) {
            const data = await res.json();
            // Expect { result: <number> }
            if (typeof data.result === 'number') {
              showResult(data.result, pa.value, pb.value, op);
              return;
            } else {
              // Server returned malformed response; fall back
              console.warn('Server returned unexpected response, falling back to client calculation', data);
            }
          } else {
            // Server responded with error status; read message if any
            let data;
            try { data = await res.json(); } catch(e){ data = null; }
            console.warn('Server error', res.status, data);
            // fall through to local calc
          }
        } catch (err) {
          // network error -> fallback
          console.warn('Fetch failed, performing local calc', err);
        }

        // Local calculation fallback
        const r = localCompute(pa.value, pb.value, op);
        showResult(r, pa.value, pb.value, op);
      }

      function showResult(value, a, b, op) {
        // Format value: show up to 12 significant digits, drop trailing zeros
        const formatted = (Math.abs(value) >= 1e12 || (Math.abs(value) < 1e-6 && value !== 0))
          ? value.toExponential(6)
          : Number.isInteger(value) ? String(value) : String(Number(value.toPrecision(12))).replace(/(?:\.0+|(\.\d+?)0+)$/,'$1');

        resultEl.textContent = formatted;
        metaEl.textContent = `${a} ${opSymbol(op)} ${b} = ${formatted}`;
        resultBox.hidden = false;
      }

      // Events
      calcBtn.addEventListener('click', doCalc);
      clearBtn.addEventListener('click', () => { aEl.value=''; bEl.value=''; clearMsgs(); aEl.focus(); });

      // Use keydown instead of deprecated keypress; Enter triggers calc
      [aEl, bEl].forEach(el => el.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); doCalc(); } }));

      // Small client-side UX: prevent typing letters in inputs (soft enforcement)
      function allowNumericKey(e) {
        // allow control keys: backspace, tab, arrows, delete, home/end
        const allowed = ['Backspace','Tab','ArrowLeft','ArrowRight','Delete','Home','End','Enter'];
        if (allowed.includes(e.key)) return;
        // allow digits, decimal point, plus/minus, and 'e' for exponent if you want
        if (/^[0-9.+\-eE]$/.test(e.key)) return;
        e.preventDefault();
      }
      aEl.addEventListener('keydown', allowNumericKey);
      bEl.addEventListener('keydown', allowNumericKey);

      // initial focus
      aEl.focus();

    </script>
  </body>
</html>
